# 依赖注入

props 传递有一个问题-- 层数过多会很烦琐. 而且中间层可能压根就不关心这个 props, 但是为了向下传递, 还是需要定义.

如果链路很长, 可能会影响这条路上的组件.

这个问题被称为`props逐级透传`

`provide` 和 `inject` 就是用来解决这个问题的

## provide

`provide` 选项为后代提供数据.

对于 provide 对象上的每一个属性，后代组件会用其 key 为注入名查找期望注入的值，属性的值就是要提供的数据。

如果我们需要提供依赖当前组件实例的状态 (比如那些由 data() 定义的数据属性)，那么可以以函数形式使用 provide：

```js
export default {
  data() {
    return {
      message: 'hello!',
    };
  },
  provide() {
    // 使用函数的形式，可以访问到 `this`
    return {
      message: this.message,
    };
  },
};
```

> 注意: 这样的 provide 不是响应式的.

## 应用层 provide

```js
import { createApp } from 'vue';

const app = createApp({});

app.provide(/* 注入名 */ 'message', /* 值 */ 'hello!');
```

这能够让应用内所有组件都注入数据

## inject

```js
export default {
  inject: ['message'],
  created() {
    console.log(this.message); // injected value
  },
};
```

inject 会在组件的自身状态之前解析, 因此可以在 `data`, `methods`, `computed` 中使用注入的数据

### 注入别名

```js
export default {
  inject: {
    /* 本地属性名 */ localMessage: {
      from: /* 注入来源名 */ 'message',
    },
  },
};
```

然后通过 `this.localMessage` 访问

### 注入默认值

默认情况下, 如果 `inject` 没有匹配到对应的 `provide`, 会抛出一个运行时错误

为此可以声明一个默认值, 这一点和`props`非常像

```js
export default {
  // 当声明注入的默认值时
  // 必须使用对象形式
  inject: {
    message: {
      from: 'message', // 当与原注入名同名时，这个属性是可选的
      default: 'default value',
    },
    user: {
      // 对于非基础类型数据，如果创建开销比较大，或是需要确保每个组件实例
      // 需要独立数据的，请使用工厂函数
      default: () => ({ name: 'John' }),
    },
  },
};
```

## 和响应式数据配合使用

为保证注入方和供给方之间的响应性链接，我们需要使用 computed() 函数提供一个计算属性：

```js
import { computed } from 'vue';

export default {
  data() {
    return {
      message: 'hello!',
    };
  },
  provide() {
    return {
      // 显式提供一个计算属性
      message: computed(() => this.message),
    };
  },
};
```

> 这里和Vue2有区别

## 使用 Symbol 作为注入名

Symbol 的作用是穿件唯一的属性名, 放置属性名重复

Symbol 通常存储在一个文件中

```js
// keys.js
export const myInjectionKey = Symbol();
```

provide

```js
// 在供给方组件中
import { myInjectionKey } from './keys.js';

export default {
  provide() {
    return {
      [myInjectionKey]: {
        /* 要提供的数据 */
      },
    };
  },
};
```

inject

```js
// 注入方组件
import { myInjectionKey } from './keys.js';

export default {
  inject: {
    injected: { from: myInjectionKey },
  },
};
```
