# 部署

## Node.js 服务器

Next.js 可以部署到任何支持 Node.js 的托管提供商处.

需要确保 `package.json` 文件中有以下命令

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  }
}
```

执行 `build` 命令将构建用于生成环境的应用程序, 执行`start`命令将启动一个支持`混合页面`的 Node.js 服务程序.

## Dokcer 镜像

Next.js 可以被被部署到 docker 容器中

可以通过下面的`Dockerfile`文件来构建镜像 (注意文件名就要是 Dockerfile )

```shell
# Install dependencies only when needed
FROM node:alpine AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# Rebuild the source code only when needed
FROM node:alpine AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN yarn build && yarn install --production --ignore-scripts --prefer-offline

# Production image, copy all the files and run next
FROM node:alpine AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# You only need to copy next.config.js if you are NOT using the default configuration
# COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

USER nextjs

EXPOSE 3000

ENV PORT 3000

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry.
# ENV NEXT_TELEMETRY_DISABLED 1

CMD ["node_modules/.bin/next", "start"]
```

请确保这个 `Dockerfile` 放在项目的根目录, 然后通过 `docker build . -t my-next-js-app`构建镜像, 然后`docker run -p 3000:3000 my-next-js-app` 来运行

这个官方给的配置在国内用起来不顺畅..., 这个过程中会下载很多依赖, 不对 docker 使用代理有些依赖根本拉不下来.
另外一个很坑的点是, 这个文件里面用的是 yarn, 需要配置 yarn.lock

**docker 配置代理**

- 创建 `/etc/systemd/system/docker.service.d` 目录
- 创建 `http-proxy.conf` 文件
- 写入类似如下数据
  ```ini
  [Service]
  Environment="HTTP_PROXY=http://127.0.0.1:8080/"
  Environment="HTTPS_PROXY=http://127.0.0.1:8080/"
  Environment="NO_PROXY=localhost,127.0.0.1"
  ```
- 刷新配置文件 `sudo systemctl daemon-reload`
- 重启 docker 服务`sudo service docker restart`

**yarn 和 yarn.lock**

- 下载 yarn `npm i -g yarn`
- 生成 yarn.lock 文件 `yarn install --update-checksums`

**使用自己的 Dockerfile**

```ini
FROM node:lastest
RUN mkdir -p /var/www/next
ADD . /var/www/next
WORKDIR /var/www/next
ENV NODE_ENV production
RUN npm build
USER nextjs

EXPOSE 3000

ENV PORT 3000

CMD ["npm", "start"]
```

然后创建镜像 `docker build . -t my-next-js-app-2` , 创建容器`docker run -p 3000:3000 my-next-js-app-2`
